<?xml version="1.0"?>
<!DOCTYPE project>

<project name="build-nodejs" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-common.xml" />

	<macrodef name="download-node">
		<sequential>
			<if>
				<os arch="x86_32" family="mac" />
				<then>
					<propertycopy from="nodejs.url[osx32]" name="nodejs.url" />
				</then>
				<elseif>
					<os arch="x86_64" family="mac" />
					<then>
						<propertycopy from="nodejs.url[osx64]" name="nodejs.url" />
					</then>
				</elseif>
				<elseif>
					<os arch="amd" family="unix" />
					<then>
						<propertycopy from="nodejs.url[linux32]" name="nodejs.url" />
					</then>
				</elseif>
				<elseif>
					<os arch="amd64" family="unix" />
					<then>
						<propertycopy from="nodejs.url[linux64]" name="nodejs.url" />
					</then>
				</elseif>
				<elseif>
					<os arch="x86" family="windows" />
					<then>
						<propertycopy from="nodejs.url[windows32]" name="nodejs.url" />
					</then>
				</elseif>
				<elseif>
					<os arch="amd64" family="windows" />
					<then>
						<propertycopy from="nodejs.url[windows64]" name="nodejs.url" />
					</then>
				</elseif>
			</if>

			<if>
				<not>
					<isset property="nodejs.url" />
				</not>
				<then>
					<fail>
.

Unable to automatically detect the current operating system and architecture.
Please manually set the property "nodejs.url" in build.properties to the
location of NodeJS. An example value for OSX on a 64 bit architecture is
${nodejs.url[osx64]}.
					</fail>
				</then>
			</if>

			<if>
				<not>
					<available file="${sdk.tools.dir}/node-v${nodejs.version}" />
				</not>
				<then>
					<antelope:stringutil string="${nodejs.url}" property="nodejs.file.beginindex">
						<antelope:lastindexof string="/" />
					</antelope:stringutil>

					<math
						datatype="int"
						operand1="${nodejs.file.beginindex}"
						operand2="1"
						operation="+"
						result="nodejs.file.beginindex"
					/>

					<antelope:stringutil string="${nodejs.url}" property="nodejs.file">
						<antelope:substring beginindex="${nodejs.file.beginindex}" />
					</antelope:stringutil>

					<if>
						<not>
							<available file="${sdk.tools.dir}/${nodejs.file}" />
						</not>
						<then>
							<mirrors-get dest="${sdk.tools.dir}/${nodejs.file}" src="${nodejs.url}" />
						</then>
					</if>

					<if>
						<contains string="${nodejs.file}" substring=".tar.gz" />
						<then>
							<exec executable="tar">
								<arg line="xfz ${sdk.tools.dir}/${nodejs.file} -C ${sdk.tools.dir}"/>
							</exec>

							<antelope:stringutil string="${nodejs.file}" property="nodejs.dir.endindex">
								<antelope:lastindexof string=".tar.gz" />
							</antelope:stringutil>

							<antelope:stringutil string="${nodejs.file}" property="nodejs.dir">
								<antelope:substring endindex="${nodejs.dir.endindex}" />
							</antelope:stringutil>

							<delete dir="${sdk.tools.dir}/node-v${nodejs.version}" />

							<move file="${sdk.tools.dir}/${nodejs.dir}" tofile="${sdk.tools.dir}/node-v${nodejs.version}" />

							<mkdir dir="${sdk.tools.dir}/node-v${nodejs.version}/node_modules" />
						</then>
						<else>
							<move file="${sdk.tools.dir}/${nodejs.file}" todir="${sdk.tools.dir}/node-v${nodejs.version}" />
						</else>
					</if>

					<if>
						<os family="windows" />
						<then>
							<if>
								<not>
									<available file="${sdk.tools.dir}/npm-${nodejs.npm.version}.zip" />
								</not>
								<then>
									<mirrors-get dest="${sdk.tools.dir}/npm-${nodejs.npm.version}.zip" src="${nodejs.npm.url}" />
								</then>
							</if>

							<unzip
								dest="${sdk.tools.dir}/node-v${nodejs.version}"
								src="${sdk.tools.dir}/npm-${nodejs.npm.version}.zip"
							/>
						</then>
					</if>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="node-execute">
		<attribute name="command"/>
		<attribute default="" name="command.args" />
		<attribute default="${user.dir}" name="working.dir" />

		<sequential>
			<property name="node.args" value="" />
			<exec dir="@{working.dir}" executable="${sdk.tools.dir}/node-v${nodejs.version}/bin/@{command}">
				<arg line="@{command.args} ${node.args}"/>
			</exec>
		</sequential>
	</macrodef>

	<target name="download-node">
		<download-node />
	</target>

	<target name="download-node-module-babel" depends="download-node">
		<if>
			<not>
				<available file="${sdk.tools.dir}/node-v${nodejs.version}/node_modules/babel" />
			</not>
			<then>
				<antcall target="npm-execute">
					<param name="node.args" value="install babel" />
				</antcall>
			</then>
		</if>
	</target>

	<target name="download-node-module-lfr-amd-loader" depends="download-node">
		<if>
			<not>
				<available file="${sdk.tools.dir}/node-v${nodejs.version}/node_modules/lfr-amd-loader" />
			</not>
			<then>
				<antcall target="npm-execute">
					<param name="node.args" value="install lfr-amd-loader" />
				</antcall>
			</then>
		</if>
	</target>

	<target name="download-node-module-lfr-module-config-generator" depends="download-node">
		<if>
			<not>
				<available file="${sdk.tools.dir}/node-v${nodejs.version}/node_modules/lfr-module-config-generator" />
			</not>
			<then>
				<antcall target="npm-execute">
					<param name="node.args" value="install lfr-module-config-generator" />
				</antcall>
			</then>
		</if>
	</target>

	<target name="transpile-js-files" depends="download-node-module-babel,download-node-module-lfr-amd-loader,download-node-module-lfr-module-config-generator">
		<property name="transpiler.force" value="false" />

		<outofdate outputsourcespath="outdated-files" force="${transpiler.force}">
			<sourcefiles>
				<fileset dir="${transpiler.input.dir}">
					<include name="**/*.js" />
				</fileset>
			</sourcefiles>
			<mapper type="glob" dir="${transpiler.input.dir}" from="*.js" to="${transpiler.output.dir}/*.js" />
			<sequential>
				<if>
					<istrue value="${transpiler.force}" />
					<then>
						<path id="outdated-files">
							<fileset dir="${transpiler.input.dir}">
								<include name="**/*.js" />
							</fileset>
						</path>
					</then>
				</if>
				<pathconvert pathsep=" " property="outdated-files-param" setonempty="false" refid="outdated-files" >
					<map from="${transpiler.input.dir}/" to="" />
				</pathconvert>

				<node-execute
					command="node"
					command.args="${sdk.tools.dir}/node-v${nodejs.version}/node_modules/babel/bin/babel/index.js --modules amd -d ${transpiler.output.dir} ${outdated-files-param}"
					working.dir="${transpiler.input.dir}" />

			</sequential>
		</outofdate>
	</target>

	<target name="generate-modules-config" depends="download-node-module-lfr-module-config-generator">
		<echo>
			${sdk.tools.dir}/node-v${nodejs.version}/node_modules/lfr-module-config-generator/bin/index.js -l -e '${config.generator.file.extension}' -f ${config.generator.module.format} -i ${config.generator.path.ignore} -c '${config.generator.config.variable}' -o ${config.generator.output.file} -p ${config.generator.file.pattern} -m ${config.generator.module.config} -r ${config.generator.root.dir} ${config.generator.input.dir}"
		</echo>

		<node-execute
			command="node"
			command.args="${sdk.tools.dir}/node-v${nodejs.version}/node_modules/lfr-module-config-generator/bin/index.js -l -e '${config.generator.file.extension}' -f ${config.generator.module.format} -i ${config.generator.path.ignore} -c '${config.generator.config.variable}' -o ${config.generator.output.file} -p ${config.generator.file.pattern} -m ${config.generator.module.config} -r ${config.generator.root.dir} ${config.generator.input.dir}"
			working.dir="${sdk.tools.dir}/node-v${nodejs.version}" />
	</target>

	<target name="node-execute" depends="download-node">
		<property name="working.dir" value="${user.dir}" />
		<node-execute
			command="node"
			working.dir="${working.dir}"
		/>
	</target>

	<target name="npm-execute" depends="download-node">
		<node-execute
			command="npm"
			working.dir="${sdk.tools.dir}/node-v${nodejs.version}"
		/>
	</target>
</project>